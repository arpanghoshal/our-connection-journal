# Autogenerated nginx configuration
# Connecting to backend at api:5002

server {
  listen 80;
  server_name localhost;
  root /app/static;
  index index.html;
  
  # Increase client body buffer size to avoid temporary files
  client_body_buffer_size 16k;
  
  # Increase proxy buffer settings
  proxy_buffers 16 32k;
  proxy_buffer_size 32k;
  
  # Gzip compression
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;
  gzip_types
    application/javascript
    application/json
    application/x-javascript
    text/css
    text/javascript
    text/plain
    text/xml;
    
  # API proxy - explicit backend config
  location /api/ {
    # Use explicit upstream configuration
    proxy_pass http://api:5002/api/;
    # Error handling
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    proxy_intercept_errors on;
    # Headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    # Long timeouts for video processing
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    # Don't buffer requests to avoid temporary files
    proxy_request_buffering off;
    # Upload size limit
    client_max_body_size 100M;
  }
  
  # Static files
  location /static/ {
    alias /app/static/;
    expires 1d;
    add_header Cache-Control "public, max-age=86400";
  }
  
  # Health check
  location /health {
    access_log off;
    return 200 'OK';
    add_header Content-Type text/plain;
  }

  location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
  }
}
